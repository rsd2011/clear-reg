import org.gradle.api.plugins.JavaPluginExtension
import org.gradle.api.tasks.testing.logging.TestExceptionFormat
import org.gradle.testing.jacoco.plugins.JacocoPluginExtension
import org.gradle.testing.jacoco.tasks.JacocoReport
import org.gradle.testing.jacoco.tasks.JacocoCoverageVerification

// backend 이하 모든 모듈에 전역 적용
subprojects { subproject ->
    plugins.withType(JavaPlugin) {
        subproject.pluginManager.apply('jacoco')

        subproject.extensions.configure(JavaPluginExtension) { javaExt ->
            javaExt.toolchain {
                languageVersion = JavaLanguageVersion.of(21)
            }
            javaExt.withSourcesJar()
            javaExt.withJavadocJar()
        }

        subproject.extensions.configure(JacocoPluginExtension) { jacocoExt ->
            jacocoExt.toolVersion = '0.8.11'
        }

        tasks.withType(Test).configureEach {
            useJUnitPlatform()
            testLogging {
                events 'passed', 'skipped', 'failed'
                exceptionFormat = TestExceptionFormat.FULL
            }
            finalizedBy(tasks.named('jacocoTestReport'))
        }

        // 핵심 도메인/인프라 코드까지 커버리지에 포함하기 위해 최소한의 예외만 둔다.
        def jacocoExclusions = ['**/*Application*.class', '**/config/**', '**/dto/**']

        def mainSourceSet = subproject.extensions.getByType(JavaPluginExtension).sourceSets.named('main').get()

        tasks.named('jacocoTestReport').configure { JacocoReport report ->
            dependsOn tasks.named('test')
            reports {
                xml.required = true
                html.required = true
            }
            report.classDirectories.setFrom(mainSourceSet.output.classesDirs.asFileTree.matching {
                exclude jacocoExclusions
            })
        }

        tasks.named('jacocoTestCoverageVerification').configure { JacocoCoverageVerification verification ->
            dependsOn tasks.named('test')
            verification.classDirectories.setFrom(mainSourceSet.output.classesDirs.asFileTree.matching {
                exclude jacocoExclusions
            })
            violationRules {
                // 1) 전체 모듈(BUNDLE) 기준 라인/브랜치 커버리지
                rule {
                    element = 'BUNDLE'
                    // 라인 커버리지 90% 이상
                    limit {
                        counter = 'LINE'
                        value   = 'COVEREDRATIO'
                        minimum = 0.90
                    }
                    // 브랜치 커버리지 80% 이상
                    limit {
                        counter = 'BRANCH'
                        value   = 'COVEREDRATIO'
                        minimum = 0.80
                    }
                }

                // 2) 클래스 단위로도 최소 라인 커버리지 80% 강제
                rule {
                    element = 'CLASS'
                    // DTO, 설정, 메인 클래스 등은 여기서 한번 더 제외 가능
                    excludes = [
                        '*.*Application',
                        '*.*Config',
                        '*.dto.*',
                        '*.request.*',
                        '*.response.*'
                    ]
                    limit {
                        counter = 'LINE'
                        value   = 'COVEREDRATIO'
                        minimum = 0.80
                    }
                }

                // 3) 분기 많은 클래스 보호용: 실제 패키지 네임스페이스에 맞게 설정
                rule {
                    element = 'PACKAGE'
                    includes = ['com.example.*.domain.*', 'com.example.*.service.*']
                    limit {
                        counter = 'BRANCH'
                        value   = 'COVEREDRATIO'
                        minimum = 0.75
                    }
                }
            }
        }

        tasks.named('check').configure {
            dependsOn tasks.named('jacocoTestCoverageVerification')
        }
    }
}
