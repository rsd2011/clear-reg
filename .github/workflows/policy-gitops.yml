name: Policy GitOps Pipeline

on:
  push:
    branches: ["main"]
    paths:
      - "docs/permission-bundle-digests.json"
      - "backend/auth/src/main/resources/permission-groups.yml"
      - "docs/permissions.md"
      - "scripts/policy-bundle/**"
      - ".github/workflows/policy-gitops.yml"
  pull_request:
    paths:
      - "docs/permission-bundle-digests.json"
      - "backend/auth/src/main/resources/permission-groups.yml"
      - "docs/permissions.md"
      - "scripts/policy-bundle/**"
  workflow_dispatch:
    inputs:
      rollback_bundle_url:
        description: "HTTP URL to an existing bundle for rollback"
        required: false
      deploy_environment:
        description: "Target environment label (staging|prod)"
        required: false
        default: "staging"

env:
  JAVA_VERSION: '21'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: gradle
      - name: Gradle schema/tests
        run: ./gradlew :backend:auth:test --tests "*PermissionDefinitionSchemaTest"
      - name: Install yamllint
        run: pip install yamllint
      - name: Lint policy yamls
        run: |
          yamllint backend/auth/src/main/resources/permission-groups.yml
      - name: Generate diff preview
        run: |
          git fetch origin main --depth 1 || true
          git diff --unified=0 origin/main... >> policy-diff.txt
      - uses: actions/upload-artifact@v4
        with:
          name: policy-diff
          path: policy-diff.txt
  bundle:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Package policy bundle
        id: package
        run: |
          BUNDLE_PATH=$(scripts/policy-bundle/package-policy-bundle.sh)
          echo "bundle-path=$BUNDLE_PATH" >> "$GITHUB_OUTPUT"
      - uses: actions/upload-artifact@v4
        with:
          name: policy-bundle
          path: build/policy-bundles
  deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: bundle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: policy-bundle
          path: policy-artifacts
      - name: Deploy latest bundle
        env:
          POLICY_GATEWAY_URL: ${{ secrets.POLICY_GATEWAY_URL }}
          POLICY_GATEWAY_TOKEN: ${{ secrets.POLICY_GATEWAY_TOKEN }}
          TARGET_ENVIRONMENT: ${{ github.event.inputs.deploy_environment || 'prod' }}
        run: |
          BUNDLE=$(ls policy-artifacts/*.tar.gz | head -n1)
          echo "Deploying $BUNDLE to $TARGET_ENVIRONMENT"
          scripts/policy-bundle/publish-policy-bundle.sh "$BUNDLE"
  rollback:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.rollback_bundle_url != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download rollback bundle
        run: |
          curl -fsSL "${{ github.event.inputs.rollback_bundle_url }}" -o rollback-bundle.tar.gz
      - name: Re-apply rollback bundle
        env:
          POLICY_GATEWAY_URL: ${{ secrets.POLICY_GATEWAY_URL }}
          POLICY_GATEWAY_TOKEN: ${{ secrets.POLICY_GATEWAY_TOKEN }}
          TARGET_ENVIRONMENT: ${{ github.event.inputs.deploy_environment || 'prod' }}
        run: |
          echo "Rolling back using $TARGET_ENVIRONMENT"
          scripts/policy-bundle/publish-policy-bundle.sh rollback-bundle.tar.gz
